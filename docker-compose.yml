services:

  mysql:
    image: mysql:8
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootroot
      MYSQL_DATABASE: medilabo_patient
    ports:
      - "3307:3306"
    networks:
      - medilabo-net
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-prootroot" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  mongo:
    image: mongo:5
    container_name: mongodb
    ports:
      - "27017:27017"
    networks:
      - medilabo-net


  keycloak:
    image: quay.io/keycloak/keycloak:26.2
    container_name: keycloak
    command: start-dev --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8090:8080"
    volumes:
      - ./medilabo-realm.json:/opt/keycloak/data/import/medilabo-realm.json
    networks:
      - medilabo-net


  medilabo-patient:
    build:
      context: ./medilabo-patient
    ports:
      - "8081:8081"
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_URL: jdbc:mysql://mysql:3306/medilabo_patient?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      DB_USERNAME: root
      DB_PASSWORD: rootroot
    networks:
      - medilabo-net

  medilabo-notes:
    build:
      context: ./medilabo-notes
    ports:
      - "8083:8083"
    depends_on:
      - mongo
    environment:
      MONGODB_HOST: mongo
      MONGODB_PORT: 27017
      MONGODB_DATABASE: notes
    networks:
      - medilabo-net

  medilabo-gateway:
    build:
      context: ./medilabo-gateway
    ports:
      - "8080:8080"
    depends_on:
      - medilabo-patient
      - medilabo-notes
      - medilabo-diabetes-assessment
    environment:
      PATIENT_URL: http://medilabo-patient:8081
      NOTES_URL: http://medilabo-notes:8083
      ASSESSMENT_URL: http://medilabo-diabetes-assessment:8084
      FRONT_URL: http://medilabo-front:8082
    networks:
      - medilabo-net

  medilabo-front:
    build:
      context: ./medilabo-front
    ports:
      - "8082:8082"
    depends_on:
      - medilabo-gateway
      - keycloak
    environment:
      KEYCLOAK_ISSUER_URI: http://host.docker.internal:8090/realms/medilabo
      KEYCLOAK_REDIRECT_URI: http://localhost:8082/login/oauth2/code/keycloak
      PATIENT_API_URL: http://medilabo-gateway:8080/api/patients
      NOTE_API_URL: http://medilabo-gateway:8080/api/notes
      ASSESSMENT_API_URL: http://medilabo-gateway:8080/assessment
    networks:
      - medilabo-net

  medilabo-diabetes-assessment:
    build:
      context: ./medilabo-diabetes-assessment
    ports:
      - "8084:8084"
    depends_on:
      - medilabo-patient
      - medilabo-notes
    environment:
      PATIENT_SERVICE_URL: http://medilabo-patient:8081/api/patients
      NOTE_SERVICE_URL: http://medilabo-notes:8083/api/notes
    networks:
      - medilabo-net

networks:
  medilabo-net:
